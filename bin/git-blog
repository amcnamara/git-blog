#!/usr/bin/env bash

BINSRC=$(dirname $(readlink -f $(which git-blog)))

source $BINSRC/_git-blog-constants.sh
source $BINSRC/_git-blog-helpers.sh
source $BINSRC/_git-blog-init.sh
source $BINSRC/_git-blog-configure.sh
source $BINSRC/_git-blog-write.sh
source $BINSRC/_git-blog-render.sh
source $BINSRC/_git-blog-build.sh
source $BINSRC/_git-blog-publish.sh

plumb_logs $@
check_dependencies

case $1 in
    init)
        initialize $2
        ;;
    configure)
        is_gitblog
        configure ${@:2}
        ;;
    write)
        is_gitblog
        write ${@:2}
        ;;
    build)
        is_gitblog
        build_args=("${@:2}")
        PORT=8080
        set -- "${build_args[@]}"
        while [[ $# -gt 0 ]]; do
            case $1 in
                -f|--fast)
                    shift
                    ;;
                -p|--port)
                    if [ -z "$2" ]; then
                        perror "Missing port: --port requires an integer"
                        exit 1
                    fi
                    if [[ ! $2 =~ ^[0-9]+$ ]]; then
                        perror "Invalid port: $2"
                        exit 1
                    fi
                    PORT=$2
                    shift 2
                    ;;
                fast)
                    perror "Use -f/--fast instead of the 'fast' argument"
                    exit 1
                    ;;
                --)
                    shift
                    break
                    ;;
                *|-*|--*)
                    perror "Unknown option: $1"
                    exit 1
                    ;;
            esac
        done
        build "${build_args[@]}"
        cd $PUBLIC_DIR
        pbold "Bringing up webserver: http://localhost:$PORT" 
        python3 -m http.server $PORT & open "http://localhost:$PORT"
        ;;
    publish)
        is_gitblog
        publish
        ;;
    doctor)
        check_dependencies
        show_dependency_versions
        ;;
    migrate)
        is_gitblog
        import_assets true
        ;;
    *)
        usage
        ;;
esac

pdebug "complete"

exit 0
